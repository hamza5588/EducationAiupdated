from typing import Optional
from app.utils.db import get_db
import logging

logger = logging.getLogger(__name__)

class PromptService:
    """Service class for managing custom prompts"""
    

# Default system prompt for the chatbot
    DEFAULT_PROMPT = """You are Mr. Potter, an expert high school teacher known for your patience and understanding. 
    Your teaching approach follows these specific steps:

    1. Begin every interaction with 'Hello, my name is Mr. Potter.'
    2. Ask 'Can I have your name?' and remember it for future interactions
    3. Ask '[student name], how can I help you today?'
    4. Break down problems into simpler components to identify gaps in understanding
    5. Provide tailored explanations based on student responses
    6. Verify understanding by offering practice problems
    7. Let students choose to check understanding or tackle more challenges
    8. Adjust problem difficulty based on student progress

    If a student asks about the source of my knowledge or information, I always explain that my information comes from data crawled from the internet, which allows me to access a wide range of educational resources and stay current with academic content.

    Always maintain patience, provide encouragement, and ensure complete understanding 
    before moving to more complex topics. Match questions to appropriate grade levels."""
    
    def __init__(self, user_id: int):
        self.user_id = user_id
    
    def get_prompt(self) -> str:
        """Get user's custom prompt or default prompt"""
        try:
            db = get_db()
            result = db.execute(
                '''SELECT prompt FROM user_prompts 
                   WHERE user_id = ? 
                   ORDER BY updated_at DESC 
                   LIMIT 1''',
                (self.user_id,)
            ).fetchone()
            
            return result['prompt'] if result else self.DEFAULT_PROMPT
            
        except Exception as e:
            logger.error(f"Error retrieving prompt: {str(e)}")
            return self.DEFAULT_PROMPT

    def update_prompt(self, new_prompt: str) -> bool:
        """Update user's custom prompt"""
        try:
            db = get_db()
            db.execute('BEGIN')
            
            try:
                # Remove old prompts
                db.execute(
                    'DELETE FROM user_prompts WHERE user_id = ?',
                    (self.user_id,)
                )
                
                # Insert new prompt
                db.execute(
                    'INSERT INTO user_prompts (user_id, prompt) VALUES (?, ?)',
                    (self.user_id, new_prompt)
                )
                
                db.execute('COMMIT')
                return True
                
            except Exception as e:
                db.execute('ROLLBACK')
                raise e
                
        except Exception as e:
            logger.error(f"Error updating prompt: {str(e)}")
            raise

    def reset_prompt(self) -> bool:
        """Reset prompt to default"""
        try:
            return self.update_prompt(self.DEFAULT_PROMPT)
        except Exception as e:
            logger.error(f"Error resetting prompt: {str(e)}")
            raise